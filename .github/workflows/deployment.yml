name: Langauge Learning CI/CD Pipeline

# When push to staging branch or when create tag starting with v-*
on:
    push:
        branches:
            - staging
        create:
            - 'v-*'

jobs:
    # jobs run test and deploy to stating server
    deploy_stating:
        if: github.ref == 'ref/heads/stating'
        runs-on: ubuntu-latest # operating system our steps will run on
        # job steps
        steps:
            # Checkout the repo
            - name: Checkout
              uses: actions/checkout@v2
            # Set up Python
            - name: Set up Python
              uses: actions/setup-python@v2
              with:
                  python-version: '3.12' # Python version we use in the project
            # Install dependencies
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
            # Run tests
            - name: Run tests
              run: |
                  pytest

            - name: Deploy to staging
              if: success() # if successfully passed the tests
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.STAGING_SSH_KEY }}
                  STAGING_HOST: ${{ secrets.STAGING_HOST }}
                  STAGING_USER: ${{ secrets.STAGING_USER }}
              run: |
                  echo "$SSH_PRIVATE_KEY" | ssh-add -
                  echo $STAGING_USER@$STAGING_USER "
                    cd /var/project/staging &&
                    git pull origin staging &&
                    python3 -m venv venv &&
                    source venv/bin/active &&
                    pip install -r requirements.txt &&
                    sudo systemctl restart staging-app.service
                  "
    deploy_production:
        if: startsWith(github.ref, 'refs/tags/v-') && github.base_ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            # Checkout the repo
            - name: Checkout
              uses: actions/checkout@v2
              with:
                  ref: ${{ github.ref }}
            # Set up Python
            - name: Set up Python
              uses: actions/setup-python@v2
              with:
              python-version: '3.12' # Python version we use in the project
            # Install dependencies
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
            # Run tests
            - name: Run tests
              run: |
                  pytest

            - name: Deploy to staging
              if: success() # if successfully passed the tests
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.PRODUCTION_SSH_KEY }}
                  STAGING_HOST: ${{ secrets.PRODUCTION_HOST }}
                  STAGING_USER: ${{ secrets.PRODUCTION_USER }}
              run: |
                  echo "$PRODUCTION_SSH_KEY" | ssh-add -
                  echo $PRODUCTION_USER@$PRODUCTION_HOST "
                    cd /var/project/production &&
                    git fetch --tags &&
                    git checkout ${{ github.ref }} &&
                    python3 -m venv venv &&
                    source venv/bin/active &&
                    pip install -r requirements.txt &&
                    sudo systemctl restart production-app.service
                  "
